@model AccurateAppend.Websites.Clients.Areas.Order.Shared.Models.ProcessFileModel

<script src="/Scripts/jquery.signalR-2.4.1.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="/signalr/hubs"></script>

<script type="text/javascript">
  var timer;

  // Reference the auto-generated proxy for the hub.
  var channel = $.connection.callbackHub;

  // Create a function that the hub can call back to issue messages to.
  channel.client.callbackComplete = function() {
    proceed();
  };

  var connectionId = "";

  function analyze(connectionId) {
    $.ajax(
      {
        type: "POST",
        url: "@this.Html.Raw(this.Model.SubmitUrl)",
        data: { requestId: connectionId },
        success: function(result) {
          if (result.Status === @((Int32) HttpStatusCode.Accepted)) {
            console.log("Analysis started. Awaiting callback with " + connectionId);
          } else if (result.Status === @((Int32) HttpStatusCode.OK)) {
            console.log("Analysis complete");
            proceed();
          } else {
            console.log('error');
          }
        }
      });

    timer = window.setInterval("deadswitchProceed()", @this.Model.Timeout.TotalMilliseconds);
  }

  function deadswitchProceed() {
    //jslogger.log("deadman switch activated @this.Model.CartId");
    proceed();
  }

  function proceed() {
    if (timer) {
      window.clearInterval(timer);
    }
    window.location.href = '@this.Model.NextUrl';
  }

  $(function() {
    console.log("Rendering wait for @this.Model.CartId");

    // Start the connection.
    $.connection.hub.start().done(function() {
      connectionId = $.connection.hub.id;
      analyze(connectionId);
      //jslogger.log("Hub activated @this.Model.CartId on @Environment.MachineName");
    });
  });
</script>

<div class="append-block">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <p style="margin: 10px 0 20px 0; text-align: left;" id="processing">
          <img style="width:200px;" src="~/Content/Shared/images/circular loading.gif" alt="processing" />
        </p>
      </div>
    </div>
  </div>
</div>