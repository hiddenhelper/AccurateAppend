@using AccurateAppend.Websites.Clients.HtmlHelpers.Styles
@Html.Layout().Promo("My Profile")


<div class="profile-block">
  <div class="container">
    @Html.Partial("~/Areas/Profile/Shared/_ProfileNavigation.cshtml", "manage-nations")
    <div class="tab-content" id="v-pills-tabContent">
      <div class="tab-pane fade active show account-information" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">
        <div class="col-block">
          @using (Html.BeginForm("Index", "Nation", new {area = "Profile"}, FormMethod.Post, new {@class = "settings-form", id = "settings"}))
          {
            <div class="table-block">
              <div class="heading-box">
                <h3>My Nations</h3>
                @Html.Buttons().PrimaryButtonLarge(" + Add Nation", "Index", "Renew", new {area = "NationBuilder"})
              </div>
              <div id="grid"></div>
              <div id="message" class="alert alert-info" style="display: none; margin: 20px 0 40px 0;">No Nations Found.</div>
              <p id="docLink">For instructions on how to connect to Nation Builder, <a href="@Url.Action("NationBuilder_Account_Setup", "Documentation", new {Area = "Public"})">click here.</a></p>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>


@section HeadContent
{
  <script src="/Scripts/jquery.signalR-2.4.1.min.js"></script>
  <!--Reference the autogenerated SignalR hub script. -->
  <script src="/signalr/hubs"></script>

  <script type="text/javascript">
    // Reference the auto-generated proxy for the hub.
    var channel = $.connection.callbackHub;

    // Create a function that the hub can call back to display messages.
    channel.client.callbackComplete = function() {
      location.href = '@Url.Action("Index", "Refresh", new {Area = "Profile", redirectTo = Url.Action("Index")})';
    };

    var connectionId = "";

    $(function() {
      // Start the connection.
      $.connection.hub.start().done(function() {
        connectionId = $.connection.hub.id;
        renderGrid();
      });
    });

    function renderGrid() {

      var dataSource = new kendo.data.DataSource({
        type: "json",
        transport: {
          read: function(options) {
            $.ajax({
              url:
                "@Url.Action("GetNationsForUserJson", "DisplayLists", new {area = "NationBuilder", includeInactive = true})",
              dataType: 'json',
              type: 'GET',
              success: function(result) {
                options.success(result);
              }
            });
          }
        },
        schema: {
          type: 'json',
          total: function(response) {
            return response.length;
          }
        },
        change: function() {
          if (this.data().length <= 0) {
            $("#grid").hide();
            $("#message").show();
            $("#docLink").hide();
          } else {
            $("#grid").show();
            $("#message").hide();
            $("#docLink").show();
          }
        }
      });

      var grid = $('#grid').data('kendoGrid');
      if (grid !== undefined && grid !== null) {
        grid.dataSource.data(dataSource);
        grid.dataSource.read();
      } else {
        $("#grid").kendoGrid({
          dataSource: dataSource,
          autobind: false,
          scrollable: false,
          filterable: false,
          groupable: false,
          columns: [
            { field: "NationName", title: "Nation Name" },
            { field: "DateRegistered", title: "Date Registered" },
            {
              field: "ChangeAccessAction",
              title: "Active",
              width: "110px",
              attributes: { style: "text-align: center;" },
              template:
                '<input type="checkbox" class="jcf-checkbox" onclick="toggleAccess(\'#=ChangeAccessAction#\',this)"  #=IsActive ? \'checked="checked"\' : \'\' #/>'
            }
          ]
        });
      }


    }

    function toggleAccess(changeAccessAction, el) {
      $("#loadingMessage").show();

      $(' <i class="fa fa-refresh fa-spin" style="font-size: 20px;"></i> ').insertAfter($(el));
      $(el).hide();

      $.ajax(
        {
          type: "POST",
          url: changeAccessAction,
          data: { requestId: connectionId },
          success: function(data) {
            switch (data.Success) {
            case @((int) HttpStatusCode.OK):
              location.href = '@Url.Action("Refresh")';
              break;
            case @((int) HttpStatusCode.Accepted):
              // wait
              break;
            default:
              alert(data.Message);
            }
          },
          error: function(xhr, status, error) {
            alert(xhr.statusText);
          }
        });
    }

  </script>

}